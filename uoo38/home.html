<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>Hamakotter</title>
  </head>
  <body>
    <h2>Online chat</h2>
    <h3>節度ある利用を心がけてください</h3>
    <form>
      名前<input type="text" value="名無しさん" id="name"> コメント<input type="text" id="msg"> <input type="submit" id = "btn" value="送信">
    </form>
    <dl id="logs"></dl>
    <h3>コメントの削除</h3>
    <h4>※管理者限定</h4>
    <table>
      <tr>
	<td>削除対象の名前</td>
	<td><input type="text" id="del_name"></td>
	<td>パスワード</td>
	<td><input type="password" id="pass_name"></td>
	<td><input type="submit" id="name_btn" value="送信"></td>
      </tr>

      <tr>
	<td>削除対象の日時</td>
	<td><input type="text" id="del_time"></td>
	<td>パスワード</td>
	<td><input type="password" id="pass_time"></td>
	<td><input type="submit" id="time_btn" value="送信"></td>
      </tr>

      <tr>
	<td>削除対象のコメント</td>
	<td><input type="text" id="del_msg"></td>
	<td>パスワード</td>
	<td><input type="password" id="pass_msg"></td>
	<td><input type="submit" id="msg_btn" value="送信"></td>
      </tr>
    </table>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://cdn.socket.io/socket.io-1.1.0.js"></script>
    <!-- <script src="./main.js"></script>  -->
    <script>
     $(function() {
       var socket = io.connect();

       socket.on('connect', function() {
	 socket.emit('msg update');
       });

       socket.on('msg open', function(msg) {
	 $('#logs').empty();
	 $.each(msg, function(key, value) {
	   var info = value.name + ' ' + formatDate(value.time);
	   var mes  = $("<div/>").text(value.msg).html();
	   $('#logs').prepend($('<dt>' + info + '</dt><dd>' + mes + '</dd>' + '<hr>'));
	 });
       });

       $('#btn').click(function(e) {
	 e.preventDefault();
	 var time = new Date();
	 var str = $('#msg').val();
	 var name = $('#name').val()

	 if(name.length == 0)
	   name = "匿名";

	 if(str.length){
	   socket.json.emit('send msg', {
	     msg: str,
	     name: name,
	     time: time
	   });
	   $('#msg').val('').focus();
	 }
       });
       socket.on('push msg', function(data) {
	 var info = data.name + ' ' + formatDate(data.time);
	 var mes  = $("<div/>").text(data.msg).html();
	 $('#logs').prepend($('<dt>' + info + '</dt><dd>' + mes + '</dd>' + '<hr>'));
       });

       $('#name_btn').click(function(e) {
	 e.preventDefault();
	 socket.json.emit('del name', {
	   name: $('#del_name').val(),
	   pass: $('#pass_name').val()
	 });
       });
       $('#time_btn').click(function(e) {
	 e.preventDefault();
	 socket.json.emit('del time', {
	   time: $('#del_time').val(),
	   pass: $('#pass_time').val()
	 });
       });
       $('#msg_btn').click(function(e) {
	 e.preventDefault();
	 socket.json.emit('del msg', {
	   msg: $('#del_msg').val(),
	   pass: $('#pass_msg').val()
	 });
       });
     });

     function formatDate(date) {
       var date = new Date(date);
       var mon = date.getMonth() + 1;
       var tbl = new Array("日", "月", "火", "水", "木", "金", "土");
       var week = '(' + tbl[date.getDay()] + ')';
       var ret = date.getFullYear() + '/' + mon + '/' + date.getDate() + week + ' ' + date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds() + '.' + date.getMilliseconds();
       return ret;
     }
    </script>
  </body>
</html>
